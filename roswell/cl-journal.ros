#!/bin/sh
#|-*- mode:lisp -*-|#
#| <Put a one-line description here>
exec ros -Q -- $0 "$@"
|#
(ql:quickload '(:cl-journal) :silent t)

(defpackage :ros.script.cl-journal.3675449222
  (:use :cl :cl-journal :cl-journal.settings :cl-journal.lj-api :uiop/run-program))

(in-package :ros.script.cl-journal.3675449222)

(defun help ()
  (format t "~&Usage:
Livejournal client written in Common Lisp. Please run all commands in
a top level directory of your git repo. Right now client is supposed
to work on Mac OS X only.

Usage:
cl-journal.ros [command]

Commands:
    init
        Setup up a directory. Setup will ask for login name and password.
        Password will be stored in a default Mac OS X keychain.

    sync
        Find new posts and publish them. Drafts will be skipped client
        will prompt before publishing every file.

    url <file>
        Lookup url where file was published and print it

    build
        run ros build to make script run faster
"))

(defun main (&optional (command "help") (arg ()))
  (if (top-git-dir-p)
      (cond
        ((equal command "init") (setup))
        ((equal command "sync") (let* ((*livejournal-login* (get-login))
                                      (*livejournal-password* (get-password *livejournal-login*)))
                                 (if (or (equal "" *livejournal-login*)
                                         (equal "" *livejournal-password*)
                                         )
                                     (format t "Setup is not complete! Run cl-journal init from this folder")
                                     (progn
                                       (restore-posts)
                                       (publish-new-files)
                                       (publish-modified-files)
                                       (unpublish-deleted-files)
                                       )
                                     )))
        ((equal command "url") (if arg
                                   (progn
                                     (restore-posts)
                                     (let ((url (lookup-file-url arg)))
                                       (if url
                                           (format t "~a~%" url)
                                           (format t "File is not published~%"))))
                                   (format t "Please specify filename to lookup~%")))
        ((equal command "build") (run-program "ros build ~/.roswell/bin/cl-journal.ros"))
        (t (help)))
      (progn
        (format t "Please run this command from top level directory in the git repo~%~%")
        (help)
        )))

;;; vim: set ft=lisp lisp:
